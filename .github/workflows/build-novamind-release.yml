name: Build & Release NovaMind Lite OS (Debian bookworm)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.1.0 або nightly-001)"
        required: true
        default: nightly-${{ github.run_number }}

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y live-build xorriso syslinux-common squashfs-tools debootstrap ca-certificates parted
      - name: Build ISO (force bookworm)
        run: |
          sudo rm -rf config/* cache/* chroot/* binary/* || true
          sudo lb clean || true
          sudo lb config --distribution bookworm             --mirror-bootstrap http://deb.debian.org/debian/             --mirror-binary    http://deb.debian.org/debian/             --mirror-chroot    http://deb.debian.org/debian/             --mirror-chroot-security http://security.debian.org/debian-security/             --mirror-binary-security http://security.debian.org/debian-security/
          sudo lb build
          ls -lh
      - name: Collect ISO
        run: |
          ISO=$(ls *.iso 2>/dev/null || ls live-image-*.iso 2>/dev/null || ls */*.iso 2>/dev/null)
          cp "$ISO" novamind-lite-os-live-amd64.iso
      - name: Checksums
        run: |
          sha256sum novamind-lite-os-live-amd64.iso > novamind-lite-os-live-amd64.sha256
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: novamind-lite-os-live-amd64
          path: |
            novamind-lite-os-live-amd64.iso
            novamind-lite-os-live-amd64.sha256
